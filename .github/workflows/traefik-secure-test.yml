name: Test Traefik OAuth2 and TLS Configuration

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  validate-compose:
    name: Validate Secure Compose Files
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      matrix:
        compose-file:
          - compose.traefik.secure.yml
          - compose.traefik.secure.tls.yml
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Validate ${{ matrix.compose-file }} syntax
        run: |
          cp ./workspaces/test/dtaas/config/.env.example ./workspaces/test/dtaas/config/.env
          docker compose -f workspaces/test/dtaas/${{ matrix.compose-file }} --env-file workspaces/test/dtaas/config/.env config > /dev/null
          echo "‚úÖ ${{ matrix.compose-file }} syntax is valid"

      - name: Validate CI overlay compose files syntax
        run: |
          cp ./workspaces/test/dtaas/config/.env.example ./workspaces/test/dtaas/config/.env
          docker compose \
            -f workspaces/test/dtaas/compose.traefik.secure.yml \
            -f workspaces/test/dtaas/compose.ci.override.yml \
            --env-file workspaces/test/dtaas/config/.env \
            config > /dev/null
          echo "‚úÖ compose.ci.override.yml syntax is valid"
          docker compose \
            --profile local-certs \
            -f workspaces/test/dtaas/compose.traefik.secure.tls.yml \
            -f workspaces/test/dtaas/compose.ci.tls.override.yml \
            --env-file workspaces/test/dtaas/config/.env \
            config > /dev/null
          echo "‚úÖ compose.ci.tls.override.yml syntax is valid"

  test-traefik-secure:
    name: Test Traefik Secure Setup
    strategy:
      fail-fast: false
      matrix:
        arch:
          - platform: linux/amd64
            runner: ubuntu-latest
          - platform: linux/arm64
            runner: ubuntu-24.04-arm
    needs: validate-compose
    runs-on: ${{ matrix.arch.runner }}
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up QEMU for multi-platform builds
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3.7.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Build workspace image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: ./workspaces
          file: workspaces/Dockerfile.ubuntu.noble.gnome
          push: false
          load: true
          platforms: ${{ matrix.arch.platform }}
          tags: workspace:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Pull the docker images used in compose files
        run: |
          docker pull traefik:v3.6.4
          docker pull thomseddon/traefik-forward-auth:2.2.0
          docker pull dexidp/dex:v2.41.1
          docker pull intocps/dtaas-web:latest || \
            echo "‚ö†Ô∏è DTaaS web image not available, will skip"
          docker pull mltooling/ml-workspace-minimal:0.13.2

      - name: Create DTaaS configuration files
        run: |
          set -e
          cp ./workspaces/test/dtaas/config/.env.example ./workspaces/test/dtaas/config/.env
          cp ./workspaces/test/dtaas/config/conf.example ./workspaces/test/dtaas/config/conf
          cp ./workspaces/test/dtaas/config/client.js.example ./workspaces/test/dtaas/config/client.js

      # Make the Dex Docker service name resolvable from the CI runner host.
      # This is required because traefik-forward-auth redirects the browser to
      # http://dex:5556/dex/auth?... and curl (running on the host) must be
      # able to follow that redirect.
      - name: Add Dex hostname to /etc/hosts
        run: echo "127.0.0.1 dex" | sudo tee -a /etc/hosts

      - name: Start services (with CI Dex OIDC override)
        run: |
          docker compose \
            -f workspaces/test/dtaas/compose.traefik.secure.yml \
            -f workspaces/test/dtaas/compose.ci.override.yml \
            --env-file workspaces/test/dtaas/config/.env \
            up -d
          echo "‚è≥ Waiting for services to be ready..."
          sleep 90

      - name: Check service health (HTTP)
        run: |
          echo "üìä Checking service status..."
          docker compose \
            -f workspaces/test/dtaas/compose.traefik.secure.yml \
            -f workspaces/test/dtaas/compose.ci.override.yml \
            --env-file workspaces/test/dtaas/config/.env \
            ps
          echo "---"
          # Check if all services are running
          SERVICES=$(docker compose \
            -f workspaces/test/dtaas/compose.traefik.secure.yml \
            -f workspaces/test/dtaas/compose.ci.override.yml \
            --env-file workspaces/test/dtaas/config/.env \
            ps --format json)
          if echo "$SERVICES" | head -1 | grep -q '^\['; then
            # JSON array format
            FAILED=$(echo "$SERVICES" | jq -r '.[] | select(.State != "running") | .Name')
          else
            # Newline-delimited JSON format
            FAILED=$(echo "$SERVICES" | jq -r 'select(.State != "running") | .Name')
          fi
          if [ -n "$FAILED" ]; then
            echo "‚ùå Some services are not running:"
            echo "$FAILED"
            docker compose \
              -f workspaces/test/dtaas/compose.traefik.secure.yml \
              -f workspaces/test/dtaas/compose.ci.override.yml \
              --env-file workspaces/test/dtaas/config/.env \
              logs
            exit 1
          fi
          echo "‚úÖ All services are running"

      # Verify traefik-forward-auth is actually enforcing auth (unrequested
      # access should redirect to Dex, not return 200 directly).
      - name: Verify auth is enforced (expect redirect, not 200)
        run: |
          echo "Verifying that unauthenticated requests are redirected..."
          response=$(curl -s -o /dev/null -w "%{http_code}" \
            --max-redirs 0 http://localhost/user1/ 2>/dev/null || echo "000")
          echo "Unauthenticated response code: $response"
          if [ "$response" = "302" ] || [ "$response" = "307" ]; then
            echo "‚úÖ Auth middleware is active (unauthenticated -> redirect)"
          else
            echo "‚ùå Expected 302/307 redirect but got $response"
            docker compose \
              -f workspaces/test/dtaas/compose.traefik.secure.yml \
              -f workspaces/test/dtaas/compose.ci.override.yml \
              --env-file workspaces/test/dtaas/config/.env \
              logs traefik traefik-forward-auth dex
            exit 1
          fi

      # Perform the full automated OAuth2 login flow and verify that an
      # authenticated request reaches the workspace service (HTTP 200).
      - name: Test automated OAuth2 login via Dex (user1)
        run: |
          chmod +x workspaces/test/dtaas/scripts/ci_auth_login.sh
          workspaces/test/dtaas/scripts/ci_auth_login.sh \
            http://localhost user1 http://dex:5556 password

      - name: Show service logs on failure
        if: failure()
        run: |
          echo "=== Traefik Logs ==="
          docker compose \
            -f workspaces/test/dtaas/compose.traefik.secure.yml \
            -f workspaces/test/dtaas/compose.ci.override.yml \
            --env-file workspaces/test/dtaas/config/.env \
            logs traefik
          echo "=== Traefik Forward Auth Logs ==="
          docker compose \
            -f workspaces/test/dtaas/compose.traefik.secure.yml \
            -f workspaces/test/dtaas/compose.ci.override.yml \
            --env-file workspaces/test/dtaas/config/.env \
            logs traefik-forward-auth
          echo "=== Dex Logs ==="
          docker compose \
            -f workspaces/test/dtaas/compose.traefik.secure.yml \
            -f workspaces/test/dtaas/compose.ci.override.yml \
            --env-file workspaces/test/dtaas/config/.env \
            logs dex

      - name: Cleanup (HTTP)
        if: always()
        run: |
          docker compose \
            -f workspaces/test/dtaas/compose.traefik.secure.yml \
            -f workspaces/test/dtaas/compose.ci.override.yml \
            --env-file workspaces/test/dtaas/config/.env \
            down -v
          docker system prune -f

  test-traefik-secure-tls:
    name: Test Traefik with TLS
    strategy:
      fail-fast: false
      matrix:
        arch:
          - platform: linux/amd64
            runner: ubuntu-latest
          - platform: linux/arm64
            runner: ubuntu-24.04-arm
    needs: validate-compose
    runs-on: ${{ matrix.arch.runner }}
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1

      - name: Set up QEMU for multi-platform builds
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3.7.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435  # v3.11.1

      - name: Build workspace image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83  # v6.18.0
        with:
          context: ./workspaces
          file: workspaces/Dockerfile.ubuntu.noble.gnome
          push: false
          load: true
          platforms: ${{ matrix.arch.platform }}
          tags: workspace:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Install mkcert and generate TLS certificates
        run: |
          set -e
          # ‚îÄ‚îÄ Install mkcert (version-pinned, architecture-aware) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          ARCH=$(uname -m)
          case "${ARCH}" in
            x86_64)  MKCERT_ARCH="linux-amd64" ;;
            aarch64) MKCERT_ARCH="linux-arm64" ;;
            *)        echo "‚ùå Unsupported architecture: ${ARCH}"; exit 1 ;;
          esac
          MKCERT_VERSION="v1.4.4"
          curl -fsSL \
            "https://github.com/FiloSottile/mkcert/releases/download/${MKCERT_VERSION}/mkcert-${MKCERT_VERSION}-${MKCERT_ARCH}" \
            -o /tmp/mkcert
          chmod +x /tmp/mkcert
          sudo mv /tmp/mkcert /usr/local/bin/mkcert

          # ‚îÄ‚îÄ Install the mkcert root CA into the system trust store ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          mkcert -install

          # ‚îÄ‚îÄ Generate certificate for localhost ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          # Write directly to the file names that Traefik expects (see
          # dynamic/tls.yml: certFile=fullchain.pem, keyFile=privkey.pem).
          mkdir -p workspaces/test/dtaas/certs
          mkcert \
            -cert-file workspaces/test/dtaas/certs/fullchain.pem \
            -key-file  workspaces/test/dtaas/certs/privkey.pem \
            localhost 127.0.0.1 ::1
          chmod 644 workspaces/test/dtaas/certs/fullchain.pem
          chmod 600 workspaces/test/dtaas/certs/privkey.pem
          echo "‚úÖ mkcert certificates generated"

          # ‚îÄ‚îÄ Copy the root CA for the traefik-forward-auth-local Docker build
          cp "$(mkcert -CAROOT)/rootCA.pem" \
            workspaces/test/dtaas/certs/rootCA.crt

          # ‚îÄ‚îÄ Build traefik-forward-auth-local (embeds the local root CA) ‚îÄ‚îÄ
          docker build \
            -t traefik-forward-auth-local:latest \
            workspaces/test/dtaas/certs/
          echo "‚úÖ traefik-forward-auth-local image built"

      - name: Verify TLS configuration file
        run: |
          if [ -f workspaces/test/dtaas/dynamic/tls.yml ]; then
            echo "‚úÖ TLS configuration file exists"
            cat workspaces/test/dtaas/dynamic/tls.yml
          else
            echo "‚ùå TLS configuration file not found"
            exit 1
          fi

      - name: Create DTaaS configuration files
        run: |
          set -e
          cp ./workspaces/test/dtaas/config/.env.ci.example \
            ./workspaces/test/dtaas/config/.env
          cp ./workspaces/test/dtaas/config/conf.example ./workspaces/test/dtaas/config/conf
          cp ./workspaces/test/dtaas/config/client.js.example ./workspaces/test/dtaas/config/client.js

      # Make the Dex Docker service name resolvable from the CI runner host.
      # This is required because traefik-forward-auth redirects the browser to
      # http://dex:5556/dex/auth?... and curl (running on the host) must be
      # able to follow that redirect.
      - name: Add Dex hostname to /etc/hosts
        run: echo "127.0.0.1 dex" | sudo tee -a /etc/hosts

      - name: Pull the docker images used in compose files
        run: |
          docker pull traefik:v3.6.4
          # Pre-pull the base image layer used inside certs/Dockerfile
          docker pull thomseddon/traefik-forward-auth:fix-dont-require-self-middleware-test1
          docker pull dexidp/dex:v2.41.1
          docker pull intocps/dtaas-web:latest || \
            echo "‚ö†Ô∏è DTaaS web image not available, will skip"
          docker pull mltooling/ml-workspace-minimal:0.13.2

      - name: Start services (with CI Dex OIDC override, TLS)
        run: |
          docker compose \
            --profile local-certs \
            -f workspaces/test/dtaas/compose.traefik.secure.tls.yml \
            -f workspaces/test/dtaas/compose.ci.tls.override.yml \
            --env-file workspaces/test/dtaas/config/.env \
            up -d
          echo "‚è≥ Waiting for services to be ready..."
          sleep 180

      - name: Check service health (TLS)
        run: |
          echo "üìä Checking service status..."
          docker compose \
            --profile local-certs \
            -f workspaces/test/dtaas/compose.traefik.secure.tls.yml \
            -f workspaces/test/dtaas/compose.ci.tls.override.yml \
            --env-file workspaces/test/dtaas/config/.env \
            ps
          echo "---"
          # Check if all services are running
          SERVICES=$(docker compose \
            --profile local-certs \
            -f workspaces/test/dtaas/compose.traefik.secure.tls.yml \
            -f workspaces/test/dtaas/compose.ci.tls.override.yml \
            --env-file workspaces/test/dtaas/config/.env \
            ps --format json)
          if echo "$SERVICES" | head -1 | grep -q '^\['; then
            # JSON array format
            FAILED=$(echo "$SERVICES" | jq -r '.[] | select(.State != "running") | .Name')
          else
            # Newline-delimited JSON format
            FAILED=$(echo "$SERVICES" | jq -r 'select(.State != "running") | .Name')
          fi
          if [ -n "$FAILED" ]; then
            echo "‚ùå Some services are not running:"
            echo "$FAILED"
            docker compose \
              --profile local-certs \
              -f workspaces/test/dtaas/compose.traefik.secure.tls.yml \
              -f workspaces/test/dtaas/compose.ci.tls.override.yml \
              --env-file workspaces/test/dtaas/config/.env \
              logs
            exit 1
          fi
          echo "‚úÖ All services are running"

      # Verify traefik-forward-auth is actually enforcing auth (unrequested
      # access should redirect to Dex, not return 200 directly).
      - name: Verify auth is enforced (expect redirect, not 200)
        run: |
          echo "Verifying that unauthenticated requests are redirected..."
          response=$(curl -s -o /dev/null -w "%{http_code}" \
            --cacert "$(mkcert -CAROOT)/rootCA.pem" \
            --max-redirs 0 https://localhost/user1/ 2>/dev/null || echo "000")
          echo "Unauthenticated response code: $response"
          if [ "$response" = "302" ] || [ "$response" = "307" ]; then
            echo "‚úÖ Auth middleware is active (unauthenticated -> redirect)"
          else
            echo "‚ùå Expected 302/307 redirect but got $response"
            docker compose \
              --profile local-certs \
              -f workspaces/test/dtaas/compose.traefik.secure.tls.yml \
              -f workspaces/test/dtaas/compose.ci.tls.override.yml \
              --env-file workspaces/test/dtaas/config/.env \
              logs traefik traefik-forward-auth dex
            exit 1
          fi

      # Perform the full automated OAuth2 login flow over HTTPS and verify
      # that an authenticated request reaches the workspace service (HTTP 200).
      # The mkcert root CA is passed so that Python requests validates the
      # certificate instead of bypassing verification.
      - name: Test automated OAuth2 login via Dex (user1, TLS)
        run: |
          pip install --quiet requests
          python3 workspaces/test/dtaas/scripts/ci_auth_login.py \
            https://localhost user1 http://dex:5556 password \
            --ca-bundle "$(mkcert -CAROOT)/rootCA.pem"

      - name: Test HTTP to HTTPS redirect
        run: |
          echo "Testing HTTP to HTTPS redirect..."
          response=$(curl -s -o /dev/null -w "%{http_code}" \
            -L --max-redirs 0 http://localhost/ 2>/dev/null || echo "000")

          if [ "$response" = "301" ] || [ "$response" = "308" ]; then
            echo "‚úÖ HTTP to HTTPS redirect is working (HTTP $response)"
          else
            echo "‚ö†Ô∏è Unexpected redirect behavior (HTTP $response)"
            echo "This might be expected if Traefik is still initializing"
          fi

      - name: Verify TLS certificate is loaded
        run: |
          echo "Checking Traefik logs for TLS certificate loading..."
          docker compose \
            --profile local-certs \
            -f workspaces/test/dtaas/compose.traefik.secure.tls.yml \
            -f workspaces/test/dtaas/compose.ci.tls.override.yml \
            --env-file workspaces/test/dtaas/config/.env \
            logs traefik \
            | grep -i "certificate" || echo "No certificate messages in logs"

      - name: Show service logs on failure
        if: failure()
        run: |
          echo "=== Traefik Logs ==="
          docker compose \
            --profile local-certs \
            -f workspaces/test/dtaas/compose.traefik.secure.tls.yml \
            -f workspaces/test/dtaas/compose.ci.tls.override.yml \
            --env-file workspaces/test/dtaas/config/.env \
            logs traefik
          echo "=== Traefik Forward Auth Logs ==="
          docker compose \
            --profile local-certs \
            -f workspaces/test/dtaas/compose.traefik.secure.tls.yml \
            -f workspaces/test/dtaas/compose.ci.tls.override.yml \
            --env-file workspaces/test/dtaas/config/.env \
            logs traefik-forward-auth
          echo "=== Dex Logs ==="
          docker compose \
            --profile local-certs \
            -f workspaces/test/dtaas/compose.traefik.secure.tls.yml \
            -f workspaces/test/dtaas/compose.ci.tls.override.yml \
            --env-file workspaces/test/dtaas/config/.env \
            logs dex
          echo "=== User1 Logs ==="
          docker compose \
            --profile local-certs \
            -f workspaces/test/dtaas/compose.traefik.secure.tls.yml \
            -f workspaces/test/dtaas/compose.ci.tls.override.yml \
            --env-file workspaces/test/dtaas/config/.env \
            logs user1 \
            | tail -50

      - name: Cleanup (TLS)
        if: always()
        run: |
          docker compose \
            --profile local-certs \
            -f workspaces/test/dtaas/compose.traefik.secure.tls.yml \
            -f workspaces/test/dtaas/compose.ci.tls.override.yml \
            --env-file workspaces/test/dtaas/config/.env \
            down -v
          docker system prune -f
          rm -rf workspaces/test/dtaas/certs/*.pem
          rm -f workspaces/test/dtaas/certs/rootCA.crt
