events {}

http {

    log_format my_upstream '$remote_addr [$time_local] "$request" $status'
    ' "$upstream_addr" $upstream_response_time $upstream_http_etag $remaining_part';

    map $http_referer $served_referer {
       default $http_referer;
       # TODO change to http_host? host does not include the port
       "~.*hub.*" $host/hub/;
    }

    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    map $upstream_http_location $new_location {
        default .$upstream_http_location;
    }

    upstream jupyter {
        server 127.0.0.1:8090 fail_timeout=0; # JUPYTER
    }

    server {
        listen 8080; # COREPORT

        absolute_redirect off;

        location / {
            proxy_pass http://jupyter;
            
            proxy_set_header X-Real-IP $remote_addr;
            # Todo: change to http_host? host does not include the port (= higher security?)
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Origin ""; # set origin to empty, otherwise Jupyter returns a bad origin request
        
            # websocket support
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        location = /ping {
            auth_basic off;
            return 200;
        }

        # if base path is not in request url -> alway redirect to base path
        location ~* "^(?!{WORKSPACE_BASE_URL_DECODED}).*$" {
            auth_basic off;
            return 302 {WORKSPACE_BASE_URL_ENCODED}$request_uri;
        }

        # if url is called without trailing slash, add a trailing slash, otherwise it cannot be routed correctly.
        # example: /tools/netdata -> /tools/netdata/ ; /tools/vnc -> /tools/vnc/ ; /tools/netdata/foo -(unchanged)> /tools/netdata/foo
        location ~* "^{WORKSPACE_BASE_URL_DECODED}/tools/[^/]+$" {
            # uri is only the path whereas request_uri also contains args
            return 302 $uri/$is_args$args;
        }

        location ~* "^{WORKSPACE_BASE_URL_DECODED}/tools/(?<tool>[a-zA-Z]+)/(?<remaining_part>.*)" {
            access_log /var/log/nginx/upstream.log my_upstream;

            # Allow CORS requests
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin "$http_origin";
                add_header Access-Control-Allow-Credentials "true";
                add_header Access-Control-Allow-Methods "GET, OPTIONS, DELETE, POST, PUT";
                add_header Access-Control-Allow-Headers "Authorization, Content-Type";
                add_header Content-Length 0;
                add_header Content-Type text/plain;
                return 200;
            }

            if ($tool = vnc) {
                set $tool_port 6901;
            }
            if ($tool = vscode) {
                set $tool_port 8054;
            }
           
            if ($remaining_part !~ ^/(.*)$) {
                # add slash to remaining part if it wasn't already added
                # required since base path always starts with slash
                set $remaining_part /$remaining_part;
            }

            proxy_redirect off;
            proxy_set_header Host $host;

            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Server $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_pass_request_headers on;

            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_store off;

            proxy_pass http://127.0.0.1:$tool_port$remaining_part$is_args$args;

            #gzip on;
            #gzip_proxied any;
            #gzip_types *;
        }

        # Access all-ports via /tools/PORT
        location ~* "^{WORKSPACE_BASE_URL_DECODED}/tools/(?<access_port>[0-9]+)/(?<remaining_part>.*)" {
            access_log /var/log/nginx/upstream.log my_upstream;
            
            # Allow CORS requests
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin "$http_origin";
                add_header Access-Control-Allow-Credentials "true";
                add_header Access-Control-Allow-Methods "GET, OPTIONS, DELETE, POST, PUT";
                add_header Access-Control-Allow-Headers "Authorization, Content-Type";
                add_header Content-Length 0;
                add_header Content-Type text/plain;
                return 200;
            }
            
            add_header Access-Control-Allow-Origin "$http_origin";
            add_header Access-Control-Allow-Credentials "true";

            # Disable proxy buffering - applications like guacamole have problems with this setting
            proxy_buffering off;

            proxy_redirect off;
            proxy_set_header Host $host;

            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Server $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_http_version 1.1;
            proxy_pass_request_headers on;

            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_store off;
            
            proxy_pass http://127.0.0.1:$access_port/$remaining_part$is_args$args;

            gzip on;
            gzip_proxied any;
            gzip_types *;
        }
    }
}