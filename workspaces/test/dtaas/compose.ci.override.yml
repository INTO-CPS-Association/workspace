# CI override for compose.traefik.secure.yml
#
# This file adds a local Dex OIDC provider and reconfigures traefik-forward-auth
# to use it instead of a real GitLab/GitHub OAuth application.  It is intended
# ONLY for automated CI testing – do NOT use in production.
#
# Usage:
#   docker compose \
#     -f workspaces/test/dtaas/compose.traefik.secure.yml \
#     -f workspaces/test/dtaas/compose.ci.override.yml \
#     --env-file workspaces/test/dtaas/config/.env \
#     up -d
#
# How the automated login flow works (no browser required):
#   1. curl requests the protected URL -> 302 redirect to Dex login page
#   2. curl POSTs credentials to Dex's login form endpoint
#   3. Dex skips the approval screen (skipApprovalScreen: true in dex.yml) and
#      redirects straight to http://localhost/_oauth?code=XXX
#   4. curl follows the redirect; traefik-forward-auth exchanges the code,
#      sets the _forward_auth session cookie, and redirects to the original URL
#   5. Subsequent curl requests with the cookie return HTTP 200

name: workspace-traefik-secure

services:

  # ─── Local Dex OIDC provider ───────────────────────────────────────────────
  dex:
    image: dexidp/dex:v2.41.1
    restart: unless-stopped
    command: ["dex", "serve", "/etc/dex/config.yml"]
    volumes:
      - ./config/dex.yml:/etc/dex/config.yml:ro
    # Expose port so the CI runner can follow OAuth redirects to Dex directly.
    # The CI workflow adds "dex" to /etc/hosts -> 127.0.0.1 so the Docker service
    # name resolves correctly from the host as well as from within Docker.
    ports:
      - "5556:5556"
    networks:
      - frontend
      - users

  # ─── Override traefik-forward-auth to point at Dex ─────────────────────────
  #
  # We switch the provider from generic-oauth (GitLab) to the oidc provider so
  # that traefik-forward-auth can use Dex's OIDC discovery document.  All
  # GitLab-specific variables from the base compose file are cleared by setting
  # them to empty strings; Docker Compose merges environment lists by key so the
  # last definition wins.
  traefik-forward-auth:
    environment:
      # Switch to OIDC provider (Dex)
      - DEFAULT_PROVIDER=oidc
      - PROVIDERS_OIDC_ISSUER_URL=http://dex:5556/dex
      - PROVIDERS_OIDC_CLIENT_ID=traefik-forward-auth
      - PROVIDERS_OIDC_CLIENT_SECRET=ci-test-client-secret
      # Use a deterministic secret for test reproducibility
      - SECRET=ci-test-hmac-secret-at-least-32-chars!!
      # Clear GitLab/generic-oauth variables to avoid provider confusion
      - PROVIDERS_GENERIC_OAUTH_AUTH_URL=
      - PROVIDERS_GENERIC_OAUTH_TOKEN_URL=
      - PROVIDERS_GENERIC_OAUTH_USER_URL=
      - PROVIDERS_GENERIC_OAUTH_CLIENT_ID=
      - PROVIDERS_GENERIC_OAUTH_CLIENT_SECRET=
      - PROVIDERS_GENERIC_OAUTH_SCOPE=
    # Dex must be ready before traefik-forward-auth fetches the OIDC
    # discovery document on startup.
    depends_on:
      - dex
